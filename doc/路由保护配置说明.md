# 路由保护配置说明

本项目提供了三种方式来管理路由保护和认证。

---

## 📁 相关文件

### 1. **路由配置文件** `src/config/routes.js`
集中管理所有路由的访问权限配置。

```javascript
// 公开路由（不需要登录）
export const PUBLIC_ROUTES = [
  '/',
  '/components/login',
  '/components/register',
];

// 受保护的路由（需要登录）
export const PROTECTED_ROUTES = [
  '/components/home',
  '/components/profile',
];

// 公开 API 路由（不需要 Token）
export const PUBLIC_API_ROUTES = [
  '/api/auth/login',
  '/api/auth/register',
];
```

### 2. **中间件** `src/middleware.js`
Next.js 中间件，用于路由级别的保护（目前主要用于定义配置）。

### 3. **AuthGuard 组件** `src/components/auth/AuthGuard.jsx`
用于包装需要保护的页面组件。

---

## 🛡️ 如何保护新页面

### 方法 1：使用 AuthGuard 组件（推荐）

```jsx
'use client';

import AuthGuard from '@/components/auth/AuthGuard';
import AppLayout from '@/components/layout/AppLayout';

export default function ProtectedPage() {
  return (
    <AuthGuard>
      <AppLayout>
        {/* 你的页面内容 */}
      </AppLayout>
    </AuthGuard>
  );
}
```

### 方法 2：手动检查（灵活度高）

```jsx
'use client';

import { useEffect } from 'react';
import { useRouter } from 'next/navigation';
import { useAuth } from '@/contexts/AuthContext';

export default function ProtectedPage() {
  const { isAuthenticated, loading } = useAuth();
  const router = useRouter();

  useEffect(() => {
    if (!loading && !isAuthenticated) {
      router.push('/components/login');
    }
  }, [loading, isAuthenticated, router]);

  if (loading || !isAuthenticated) {
    return <div>加载中...</div>;
  }

  return <div>受保护的内容</div>;
}
```

---

## ➕ 添加公开路由

如果要添加不需要登录的公开页面：

### 步骤 1：在 `src/config/routes.js` 中添加路由

```javascript
export const PUBLIC_ROUTES = [
  '/',
  '/components/login',
  '/components/register',
  '/components/about',        // ← 新增公开页面
  '/components/help',          // ← 新增公开页面
];
```

### 步骤 2：创建页面时不使用 AuthGuard

```jsx
// src/app/components/about/page.jsx
export default function AboutPage() {
  return <div>这是公开页面，无需登录</div>;
}
```

---

## 🔒 添加受保护路由

### 步骤 1：在 `src/config/routes.js` 中添加路由

```javascript
export const PROTECTED_ROUTES = [
  '/components/home',
  '/components/profile',
  '/components/dashboard',     // ← 新增受保护页面
];
```

### 步骤 2：使用 AuthGuard 包装页面

```jsx
// src/app/components/dashboard/page.jsx
import AuthGuard from '@/components/auth/AuthGuard';
import AppLayout from '@/components/layout/AppLayout';

export default function DashboardPage() {
  return (
    <AuthGuard>
      <AppLayout>
        <div>这是受保护的页面</div>
      </AppLayout>
    </AuthGuard>
  );
}
```

---

## 🌐 API 路由保护

### 公开 API（不需要 Token）

在 `src/config/routes.js` 中添加：

```javascript
export const PUBLIC_API_ROUTES = [
  '/api/auth/login',
  '/api/auth/register',
  '/api/auth/refresh',
  '/api/public/data',          // ← 新增公开 API
];
```

### 受保护的 API（需要 Token）

所有不在 `PUBLIC_API_ROUTES` 中的 API 都需要 Token 验证。

在 API 路由中验证 Token：

```javascript
// src/app/api/protected/route.js
import { verifyAccessToken } from '@/lib/jwt';

export async function GET(request) {
  const token = request.headers.get('Authorization')?.substring(7);
  const decoded = verifyAccessToken(token);

  if (!decoded) {
    return NextResponse.json(
      { message: '未授权' },
      { status: 401 }
    );
  }

  // 处理请求...
}
```

---

## 📝 当前路由配置

### 公开路由
- `/` - 首页
- `/components/login` - 登录页
- `/components/register` - 注册页

### 受保护路由
- `/components/home` - 用户首页
- `/components/profile` - 个人资料
- `/components/settings` - 设置
- `/components/docs` - 文档

### 公开 API
- `/api/auth/login` - 登录接口
- `/api/auth/register` - 注册接口
- `/api/auth/refresh` - Token 刷新接口

### 受保护的 API
- `/api/user/profile` - 用户信息接口（需要 Token）
- `/api/auth/logout` - 登出接口（需要 Token）

---

## 🔄 重定向配置

在 `src/config/routes.js` 中配置默认重定向：

```javascript
export const DEFAULT_LOGIN_REDIRECT = '/components/home';  // 登录成功后跳转
export const DEFAULT_LOGOUT_REDIRECT = '/components/login'; // 登出后跳转
```

---

## ⚙️ AuthGuard 自定义重定向

AuthGuard 支持自定义重定向路径：

```jsx
<AuthGuard redirectTo="/components/custom-login">
  <YourContent />
</AuthGuard>
```

---

## 💡 最佳实践

1. **集中管理** - 所有路由配置都在 `src/config/routes.js` 中
2. **优先使用 AuthGuard** - 使用 AuthGuard 组件包装页面，代码更简洁
3. **保持一致** - 新增路由时记得更新配置文件
4. **API 保护** - 敏感 API 必须在路由中验证 Token
5. **前后端双重验证** - 前端路由保护只是 UX 优化，真正的安全验证在后端 API

---

## 🚀 快速开始

1. 创建新的受保护页面：
   ```bash
   # 在 src/app/components/yourpage/ 创建 page.jsx
   ```

2. 使用 AuthGuard 包装：
   ```jsx
   import AuthGuard from '@/components/auth/AuthGuard';

   export default function YourPage() {
     return <AuthGuard>...</AuthGuard>;
   }
   ```

3. 在 routes.js 中注册（可选，用于文档记录）：
   ```javascript
   export const PROTECTED_ROUTES = [
     // ...
     '/components/yourpage',
   ];
   ```

完成！你的新页面现在已经受到保护了。
